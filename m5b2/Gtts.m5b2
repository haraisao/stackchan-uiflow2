{"category":"Gtts","color":"#a20fd2","uiflow2":{"jscode":"const CUSTOM_GTTS_LANGUAGES = {\n  \"CUSTOM_GTTS_INIT\": {\n    \"en\": \"%1 init\"\n  },\n  \"CUSTOM_GTTS_TEXT2SPEECH\": {\n    \"en\": \" %1 text2speech, text: %2\"\n  },\n  \"CUSTOM_GTTS_SET_VOLUME\": {\n    \"en\": \" %1 set_volume, x: %2\"\n  },\n  \"CUSTOM_GTTS_SPEAK\": {\n    \"en\": \" %1 speak, data: %2\"\n  },\n  \"CUSTOM_GTTS_SET_SPEAKER\": {\n    \"en\": \" %1 set_speaker, data: %2\"\n  }\n};\n\nconst initType = 'custom_gtts_init';\nBlockly.BlockRegExpList['custom_gtts'] = {\n  regexp: new RegExp(/^custom_gtts_/),\n  code: \"from Gtts import Gtts\",\n  initBlockType: initType,\n  categoryId: 'custom_gtts',\n}\nBlockly.utils.registerLanguages(CUSTOM_GTTS_LANGUAGES)\n\nBlockly.Msg.CUSTOM_GTTS_HUE = '#a20fd2'\nBlockly.Msg.CUSTOM_GTTS = 'Gtts'\n\nBlockly.utils.getcustom_gttsOptions = function() {\n  let options = [];\n  let list = Blockly.utils.getCustomNameList(initType);\n  for (let i = 0; i < list.length; i++) {\n    let value = list[i];\n    options.push([String(value), String(value)]);\n  }\n  if (options.length === 0) return [\n    ['gtts_0', 'gtts_0']\n  ];\n  return options;\n}\n\n\nBlockly.Blocks[\"custom_gtts_init\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_GTTS_INIT,\n      'args0': [\n        // { 'type': 'field_dropdown', 'name': 'NAME', 'options': Blockly.utils.getcustom_gttsOptions },\n        {\n          'type': 'field_input',\n          'name': 'NAME',\n          'text': 'gtts_0'\n        },\n\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#a20fd2\",\n      \"tool\": []\n    };\n  }\n}\n\nBlockly.Python[\"custom_gtts_init\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return `${varname} = Gtts()\\n`\n}\n\nBlockly.Blocks[\"custom_gtts_text2speech\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_GTTS_TEXT2SPEECH,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_gttsOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'text'\n        },\n      ],\n      'output': null,\n      'inputsInline': true,\n      'colour': \"#a20fd2\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_gtts_text2speech\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var text = Blockly.Python.valueToCode(block, 'text', Blockly.Python.ORDER_FUNCTION_CALL);\n  return [`${varname}.text2speech(${text})`, Blockly.Python.ORDER_NONE]\n}\n\nBlockly.Blocks[\"custom_gtts_set_volume\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_GTTS_SET_VOLUME,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_gttsOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'x'\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#a20fd2\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_gtts_set_volume\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var x = Blockly.Python.valueToCode(block, 'x', Blockly.Python.ORDER_FUNCTION_CALL);\n  return `${varname}.set_volume(${x})\\n`\n}\n\nBlockly.Blocks[\"custom_gtts_speak\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_GTTS_SPEAK,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_gttsOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'data'\n        },\n      ],\n      'output': null,\n      'inputsInline': true,\n      'colour': \"#a20fd2\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_gtts_speak\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var data = Blockly.Python.valueToCode(block, 'data', Blockly.Python.ORDER_FUNCTION_CALL);\n  return [`${varname}.speak(${data})`, Blockly.Python.ORDER_NONE]\n}\n\nBlockly.Blocks[\"custom_gtts_set_speaker\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_GTTS_SET_SPEAKER,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_gttsOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'data'\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#a20fd2\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_gtts_set_speaker\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var data = Blockly.Python.valueToCode(block, 'data', Blockly.Python.ORDER_FUNCTION_CALL);\n  return `${varname}.set_speaker(${data})\\n`\n}","toolbox":"\n<category name=\"Gtts\" colour=\"#a20fd2\" hidden=\"true\" toolboxitemid=\"custom_gtts\">\n<title text=\"Gtts\" docsLink=\"\"></title>\n<block type=\"custom_gtts_init\"/><block type=\"custom_gtts_text2speech\">\n  <value name=\"text\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block><block type=\"custom_gtts_set_volume\">\n  <value name=\"x\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block><block type=\"custom_gtts_speak\">\n  <value name=\"data\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block><block type=\"custom_gtts_set_speaker\">\n  <value name=\"data\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block>\n</category>\n","toolboxitemid":"custom_gtts","block_type":["custom_gtts___init__","custom_gtts_text2speech","custom_gtts_set_volume","custom_gtts_speak","custom_gtts_set_speaker"]},"data":{"name":"Gtts","note":{},"details":{"color":"#a20fd2","link":"","image":"","category":"Custom"},"header":{"file":"","time":"","author":"","email":"","license":"","Google":"Text-to-Speech"},"assignments":[],"example":"","source_internal":"","source_external":"from M5 import *\r\nimport requests2\r\nimport binascii\r\nimport time\r\nimport socket\r\nimport select\r\nimport json\r\nfrom comm import Command\r\nimport util\r\n_EffectsProfile=('wearable', 'handset', 'headphone', 'small-bluetooth-speaker', 'medium-bluetooth-speaker', 'large-home-entertainment', 'large-automotive', 'telephony')\r\nJP_FEMAIL=['ja-JP-Chirp3-HD-Aoede', 'ja-JP-Chirp3-HD-Kore', 'ja-JP-Chirp3-HD-Leda', 'ja-JP-Chirp3-HD-Zephyr']\r\nJP_MALE=['ja-JP-Chirp3-HD-Charon', 'ja-JP-Chirp3-HD-Fenrir', 'ja-JP-Chirp3-HD-Orus', 'ja-JP-Chirp3-HD-Puck']\r\ndef set_volume(volume=50):\r\n    Speaker.begin()\r\n    Speaker.setVolumePercentage(volume)\r\n    Speaker.end()\r\ndef play_audio(data, sample_rate=8000, volume=50):\r\n    Speaker.begin()\r\n    Speaker.setVolumePercentage(volume)\r\n    Speaker.playRaw(data, sample_rate)\r\n    while Speaker.isPlaying():\r\n        time.sleep_ms(100)\r\n    Speaker.end()\r\n    return\r","members":[{"name":"__init__","note":{},"label":{"en":"%1 init"},"params":[],"return":"","source":"        self._endpoint = \"https://texttospeech.googleapis.com/v1/text:synthesize\"\r\n        self.key_config = util.load_conf(\"/flash/apikey.txt\")\r\n        self._apikey = self.key_config.get('GOOGLE_SPEECH_KEY')\r\n\r\n        self._lang = \"ja-JP\"\r\n        self._speakingRate = \"1.2\"\r\n        self._ssmlGender = \"FEMALE\"\r\n        self._voiceName = \"ja-JP-Wavenet-B\"\r\n        self._pitch = \"5.0\"\r\n        self._volumeGain = \"0\"\r\n        self._sampleRate = \"8000\"\r\n        self._effectsProfileId = None\r\n        self.udp=None\r\n        self.request = None\r\n        self.set_volume(50)\r\n        self.parent=None\r\n        self.response=None\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"text2speech","note":{},"label":{"en":" %1 text2speech, text: %2"},"params":[{"name":"text","type":null,"default":null,"note":{},"field":""}],"return":"","source":"        url = self._endpoint+\"?key=\"+self._apikey\r\n        headers = {  'Content-Type' : 'application/json; charset=utf-8' }\r\n        data = {\r\n                 \"input\": { \"text\" : text },\r\n                 \"voice\" : {\r\n                             'languageCode' : self._lang    # en-US, ja-JP, fr-FR\r\n                            , 'name' : self._voiceName\r\n                            , 'ssmlGender' : self._ssmlGender # MALE, FEMALE, NEUTRAL\r\n                       },\r\n                 'audioConfig': {\r\n                          'audioEncoding':'LINEAR16'  # LINEAR16, MP3, OGG_OPUS\r\n                          #'audioEncoding':'MP3'  # LINEAR16, MP3, OGG_OPUS\r\n                        , 'speakingRate' : self._speakingRate   # [0.25: 4.0]\r\n                        , 'pitch' : self._pitch         # [ -20.0: 20.0]\r\n                        , 'volumeGainDb' : self._volumeGain\r\n                        , 'sampleRateHertz' : self._sampleRate # default is 22050\r\n                      }\r\n            }\r\n        \r\n        if self._effectsProfileId in _EffectsProfile:\r\n            if self._effectsProfileId == 'telephony':\r\n                data['audioConfig']['effectsProfileId'] = 'telephony-class-application'\r\n            else:\r\n                data['audioConfig']['effectsProfileId'] = self._effectsProfileId + \"-class-device\"\r\n        try:\r\n            response = requests2.post(url, data=json.dumps(data).encode('utf-8'), headers=headers)\r\n            return response\r\n        except:\r\n            return None\r","ast_return":{"code":"response","id":null},"doc_return":null},{"name":"set_volume","note":{},"label":{"en":" %1 set_volume, x: %2"},"params":[{"name":"x","type":null,"default":null,"note":{},"field":""}],"return":"","source":"        self._volume = x\r\n        set_volume(self._volume)\r\n        return\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"speak","note":{},"label":{"en":" %1 speak, data: %2"},"params":[{"name":"data","type":null,"default":null,"note":{},"field":""}],"return":"","source":"        response=self.text2speech(data)\r\n        res_=True\r\n        if response:\r\n            try:\r\n                result=response.json()\r\n                audio=binascii.a2b_base64(result['audioContent'])\r\n                if audio[:4] == b'RIFF':\r\n                    if audio[8:12] == b'WAVE':\r\n                        audio = audio[44:]\r\n                if self.parent:\r\n                    self.parent.face.start_talk()\r\n                play_audio(audio, volume=self._volume)\r\n                if self.parent:\r\n                    self.parent.face.stop_talk()              \r\n            except:\r\n                try:\r\n                    print(result)\r\n                except:\r\n                    print(\"Unknown error\")\r\n                res_ = False\r\n            res_ = True\r\n            response.close()\r\n        return res_\r","ast_return":{"code":"res_","id":null},"doc_return":null},{"name":"set_speaker","note":{},"label":{"en":" %1 set_speaker, data: %2"},"params":[{"name":"data","type":null,"default":null,"note":{},"field":""}],"return":"","source":"        self._voiceName = data\r\n        return True\r","ast_return":{"code":null,"id":null},"doc_return":null}],"python_file_name":"gtts"},"pyCode":"\r\n\"\"\"\r\nfile     Gtts\r\ntime     2025-12-18\r\nauthor   \r\nemail   \r\nlicense  \r\n\"\"\"\r\n\r\nfrom M5 import *\r\nimport requests2\r\nimport binascii\r\nimport time\r\nimport socket\r\nimport select\r\nimport json\r\nfrom comm import Command\r\nimport util\r\n_EffectsProfile=('wearable', 'handset', 'headphone', 'small-bluetooth-speaker', 'medium-bluetooth-speaker', 'large-home-entertainment', 'large-automotive', 'telephony')\r\nJP_FEMAIL=['ja-JP-Chirp3-HD-Aoede', 'ja-JP-Chirp3-HD-Kore', 'ja-JP-Chirp3-HD-Leda', 'ja-JP-Chirp3-HD-Zephyr']\r\nJP_MALE=['ja-JP-Chirp3-HD-Charon', 'ja-JP-Chirp3-HD-Fenrir', 'ja-JP-Chirp3-HD-Orus', 'ja-JP-Chirp3-HD-Puck']\r\ndef set_volume(volume=50):\r\n    Speaker.begin()\r\n    Speaker.setVolumePercentage(volume)\r\n    Speaker.end()\r\ndef play_audio(data, sample_rate=8000, volume=50):\r\n    Speaker.begin()\r\n    Speaker.setVolumePercentage(volume)\r\n    Speaker.playRaw(data, sample_rate)\r\n    while Speaker.isPlaying():\r\n        time.sleep_ms(100)\r\n    Speaker.end()\r\n    return\r\n\r\nclass Gtts:\r\n    \"\"\"\r\n    note: ''\r\n    details:\r\n        color: '#a20fd2'\r\n        link: ''\r\n        image: ''\r\n        category: Custom\r\n    example: ''\r\n    \"\"\"\r\n\r\n\r\n\r\n\r\n    def __init__(self):\r\n        \"\"\"\r\n        label:\r\n            en: '%1 init'\r\n        \"\"\"\r\n        self._endpoint = \"https://texttospeech.googleapis.com/v1/text:synthesize\"\r\n        self.key_config = util.load_conf(\"/flash/apikey.txt\")\r\n        self._apikey = self.key_config.get('GOOGLE_SPEECH_KEY')\r\n\r\n        self._lang = \"ja-JP\"\r\n        self._speakingRate = \"1.2\"\r\n        self._ssmlGender = \"FEMALE\"\r\n        self._voiceName = \"ja-JP-Wavenet-B\"\r\n        self._pitch = \"5.0\"\r\n        self._volumeGain = \"0\"\r\n        self._sampleRate = \"8000\"\r\n        self._effectsProfileId = None\r\n        self.udp=None\r\n        self.request = None\r\n        self.set_volume(50)\r\n        self.parent=None\r\n        self.response=None\r\n\r\n    def text2speech(self, text):\r\n        \"\"\"\r\n        label:\r\n            en: ' %1 text2speech, text: %2'\r\n        params:\r\n            text:\r\n                name: text\r\n        \"\"\"\r\n        url = self._endpoint+\"?key=\"+self._apikey\r\n        headers = {  'Content-Type' : 'application/json; charset=utf-8' }\r\n        data = {\r\n                 \"input\": { \"text\" : text },\r\n                 \"voice\" : {\r\n                             'languageCode' : self._lang    # en-US, ja-JP, fr-FR\r\n                            , 'name' : self._voiceName\r\n                            , 'ssmlGender' : self._ssmlGender # MALE, FEMALE, NEUTRAL\r\n                       },\r\n                 'audioConfig': {\r\n                          'audioEncoding':'LINEAR16'  # LINEAR16, MP3, OGG_OPUS\r\n                          #'audioEncoding':'MP3'  # LINEAR16, MP3, OGG_OPUS\r\n                        , 'speakingRate' : self._speakingRate   # [0.25: 4.0]\r\n                        , 'pitch' : self._pitch         # [ -20.0: 20.0]\r\n                        , 'volumeGainDb' : self._volumeGain\r\n                        , 'sampleRateHertz' : self._sampleRate # default is 22050\r\n                      }\r\n            }\r\n        \r\n        if self._effectsProfileId in _EffectsProfile:\r\n            if self._effectsProfileId == 'telephony':\r\n                data['audioConfig']['effectsProfileId'] = 'telephony-class-application'\r\n            else:\r\n                data['audioConfig']['effectsProfileId'] = self._effectsProfileId + \"-class-device\"\r\n        try:\r\n            response = requests2.post(url, data=json.dumps(data).encode('utf-8'), headers=headers)\r\n            return response\r\n        except:\r\n            return None\r\n\r\n    def set_volume(self, x):\r\n        \"\"\"\r\n        label:\r\n            en: ' %1 set_volume, x: %2'\r\n        params:\r\n            x:\r\n                name: x\r\n        \"\"\"\r\n        self._volume = x\r\n        set_volume(self._volume)\r\n        return\r\n\r\n    def speak(self, data):\r\n        \"\"\"\r\n        label:\r\n            en: ' %1 speak, data: %2'\r\n        params:\r\n            data:\r\n                name: data\r\n        \"\"\"\r\n        response=self.text2speech(data)\r\n        res_=True\r\n        if response:\r\n            try:\r\n                result=response.json()\r\n                audio=binascii.a2b_base64(result['audioContent'])\r\n                if audio[:4] == b'RIFF':\r\n                    if audio[8:12] == b'WAVE':\r\n                        audio = audio[44:]\r\n                if self.parent:\r\n                    self.parent.face.start_talk()\r\n                play_audio(audio, volume=self._volume)\r\n                if self.parent:\r\n                    self.parent.face.stop_talk()              \r\n            except:\r\n                try:\r\n                    print(result)\r\n                except:\r\n                    print(\"Unknown error\")\r\n                res_ = False\r\n            res_ = True\r\n            response.close()\r\n        return res_\r\n\r\n    def set_speaker(self, data):\r\n        \"\"\"\r\n        label:\r\n            en: ' %1 set_speaker, data: %2'\r\n        params:\r\n            data:\r\n                name: data\r\n        \"\"\"\r\n        self._voiceName = data\r\n        return True\r\n\r\n\r\n","version":"alpha2"}