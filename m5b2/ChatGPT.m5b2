{"category":"ChatGPT","color":"#810fd2","uiflow2":{"jscode":"const CUSTOM_CHATGPT_LANGUAGES = {\n  \"CUSTOM_CHATGPT_INIT\": {\n    \"en\": \"%1 init\"\n  },\n  \"CUSTOM_CHATGPT_RESET_CHAT\": {\n    \"en\": \" %1 reset_chat\"\n  },\n  \"CUSTOM_CHATGPT_SET_PROMPT\": {\n    \"en\": \" %1 set_prompt, prompt: %2\"\n  },\n  \"CUSTOM_CHATGPT_REQUEST_OPENAI\": {\n    \"en\": \" %1 request_openai, text: %2\"\n  },\n  \"CUSTOM_CHATGPT_REQUEST\": {\n    \"en\": \" %1 request, txt: %2\"\n  }\n};\n\nconst initType = 'custom_chatgpt_init';\nBlockly.BlockRegExpList['custom_chatgpt'] = {\n  regexp: new RegExp(/^custom_chatgpt_/),\n  code: \"from ChatGPT import ChatGPT\",\n  initBlockType: initType,\n  categoryId: 'custom_chatgpt',\n}\nBlockly.utils.registerLanguages(CUSTOM_CHATGPT_LANGUAGES)\n\nBlockly.Msg.CUSTOM_CHATGPT_HUE = '#810fd2'\nBlockly.Msg.CUSTOM_CHATGPT = 'ChatGPT'\n\nBlockly.utils.getcustom_chatgptOptions = function() {\n  let options = [];\n  let list = Blockly.utils.getCustomNameList(initType);\n  for (let i = 0; i < list.length; i++) {\n    let value = list[i];\n    options.push([String(value), String(value)]);\n  }\n  if (options.length === 0) return [\n    ['chatgpt_0', 'chatgpt_0']\n  ];\n  return options;\n}\n\n\nBlockly.Blocks[\"custom_chatgpt_init\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_CHATGPT_INIT,\n      'args0': [\n        // { 'type': 'field_dropdown', 'name': 'NAME', 'options': Blockly.utils.getcustom_chatgptOptions },\n        {\n          'type': 'field_input',\n          'name': 'NAME',\n          'text': 'chatgpt_0'\n        },\n\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#810fd2\",\n      \"tool\": []\n    };\n  }\n}\n\nBlockly.Python[\"custom_chatgpt_init\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return `${varname} = ChatGPT()\\n`\n}\n\nBlockly.Blocks[\"custom_chatgpt_reset_chat\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_CHATGPT_RESET_CHAT,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_chatgptOptions\n        },\n\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#810fd2\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_chatgpt_reset_chat\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return `${varname}.reset_chat()\\n`\n}\n\nBlockly.Blocks[\"custom_chatgpt_set_prompt\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_CHATGPT_SET_PROMPT,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_chatgptOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'prompt'\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#810fd2\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_chatgpt_set_prompt\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var prompt = Blockly.Python.valueToCode(block, 'prompt', Blockly.Python.ORDER_FUNCTION_CALL);\n  return `${varname}.set_prompt(${prompt})\\n`\n}\n\nBlockly.Blocks[\"custom_chatgpt_request_openai\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_CHATGPT_REQUEST_OPENAI,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_chatgptOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'text'\n        },\n      ],\n      'output': null,\n      'inputsInline': true,\n      'colour': \"#810fd2\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_chatgpt_request_openai\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var text = Blockly.Python.valueToCode(block, 'text', Blockly.Python.ORDER_FUNCTION_CALL);\n  return [`${varname}.request_openai(${text})`, Blockly.Python.ORDER_NONE]\n}\n\nBlockly.Blocks[\"custom_chatgpt_request\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_CHATGPT_REQUEST,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_chatgptOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'txt'\n        },\n      ],\n      'output': null,\n      'inputsInline': true,\n      'colour': \"#810fd2\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_chatgpt_request\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var txt = Blockly.Python.valueToCode(block, 'txt', Blockly.Python.ORDER_FUNCTION_CALL);\n  return [`${varname}.request(${txt})`, Blockly.Python.ORDER_NONE]\n}","toolbox":"\n<category name=\"ChatGPT\" colour=\"#810fd2\" hidden=\"true\" toolboxitemid=\"custom_chatgpt\">\n<title text=\"ChatGPT\" docsLink=\"\"></title>\n<block type=\"custom_chatgpt_init\"/><block type=\"custom_chatgpt_reset_chat\"/><block type=\"custom_chatgpt_set_prompt\">\n  <value name=\"prompt\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block><block type=\"custom_chatgpt_request_openai\">\n  <value name=\"text\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block><block type=\"custom_chatgpt_request\">\n  <value name=\"txt\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block>\n</category>\n","toolboxitemid":"custom_chatgpt","block_type":["custom_chatgpt___init__","custom_chatgpt_reset_chat","custom_chatgpt_set_prompt","custom_chatgpt_request_openai","custom_chatgpt_request"]},"data":{"name":"ChatGPT","note":{},"details":{"color":"#810fd2","link":"","image":"","category":"Custom"},"header":{"file":"","time":"","author":"","email":"","license":""},"assignments":[],"example":"","source_internal":"","source_external":"import os\nfrom M5 import *\nimport requests2\nimport json\nimport util\ndef main():\n  con = ChatGPT()\n  con.request(\"明日の東京では、傘は必要ですか？\")\nif __name__ == '__main__':\n  main()","members":[{"name":"__init__","note":{},"label":{"en":"%1 init"},"params":[],"return":"","source":"    self._endpoint = \"https://api.openai.com/v1/responses\"\n    self.conf = util.load_conf(\"/flash/apikey.txt\")\n    self._apikey = self.conf.get('OPENAI_KEY')\n\n    #self._endpoint = \"http://localhost:1234/v1/responses\"\n    #self._apikey = 'lm-studio'\n\n    self.model = 'gpt-5'\n    self.chat_history=[]\n    self.prompt = \"\"","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"reset_chat","note":{},"label":{"en":" %1 reset_chat"},"params":[],"return":"","source":"    self.chat_history=[]","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"set_prompt","note":{},"label":{"en":" %1 set_prompt, prompt: %2"},"params":[{"name":"prompt","type":null,"default":null,"note":{},"field":""}],"return":"","source":"    self.prompt=prompt","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"request_openai","note":{},"label":{"en":" %1 request_openai, text: %2"},"params":[{"name":"text","type":null,"default":null,"note":{},"field":""}],"return":"","source":"    url = self._endpoint\n    headers = {\n        'Authorization': f'Bearer {self._apikey}',\n        'Content-Type' : 'application/json; charset=utf-8' }\n\n    self.gen_chat_content(text)\n    data = {\n      'model': self.model,\n      'input': self.chat_history,\n      #'tools': [{\"type\": \"mcp\", \"server_label\": \"web-search\" }]\n      #'tools': [{\"type\": \"web_search_preview\"}],\n      'tools': [{\"type\": \"web_search\"}],\n    }\n    if self.prompt:\n      data[\"input\"].insert(0,\n          {\n            'role': \"developer\",\n            'content': self.prompt\n          })\n    try:\n      result = requests2.post(url, data=json.dumps(data).encode('utf-8'), headers=headers)\n      response = result.json()\n      return response\n    except:\n      print ('Error', data, json.dumps(data).encode())\n      return \"\"","ast_return":{"code":"response","id":null},"doc_return":null},{"name":"request","note":{},"label":{"en":" %1 request, txt: %2"},"params":[{"name":"txt","type":null,"default":null,"note":{},"field":""}],"return":"","source":"    result = self.talk(txt)\n    if result:\n      return self.get_system_chat_content(result)\n    return \"\"","ast_return":{"code":"''","id":null},"doc_return":null}],"python_file_name":"chatgpt"},"pyCode":"\n\"\"\"\nfile     ChatGPT\ntime     2025-12-18\nauthor   \nemail   \nlicense  \n\"\"\"\n\nimport os\nfrom M5 import *\nimport requests2\nimport json\nimport util\ndef main():\n  con = ChatGPT()\n  con.request(\"明日の東京では、傘は必要ですか？\")\nif __name__ == '__main__':\n  main()\n\nclass ChatGPT:\n    \"\"\"\n    note: ''\n    details:\n        color: '#810fd2'\n        link: ''\n        image: ''\n        category: Custom\n    example: ''\n    \"\"\"\n\n\n\n\n    def __init__(self):\n        \"\"\"\n        label:\n            en: '%1 init'\n        \"\"\"\n    self._endpoint = \"https://api.openai.com/v1/responses\"\n    self.conf = util.load_conf(\"/flash/apikey.txt\")\n    self._apikey = self.conf.get('OPENAI_KEY')\n\n    #self._endpoint = \"http://localhost:1234/v1/responses\"\n    #self._apikey = 'lm-studio'\n\n    self.model = 'gpt-5'\n    self.chat_history=[]\n    self.prompt = \"\"\n\n    def reset_chat(self):\n        \"\"\"\n        label:\n            en: ' %1 reset_chat'\n        \"\"\"\n    self.chat_history=[]\n\n    def set_prompt(self, prompt):\n        \"\"\"\n        label:\n            en: ' %1 set_prompt, prompt: %2'\n        params:\n            prompt:\n                name: prompt\n        \"\"\"\n    self.prompt=prompt\n\n    def request_openai(self, text):\n        \"\"\"\n        label:\n            en: ' %1 request_openai, text: %2'\n        params:\n            text:\n                name: text\n        \"\"\"\n    url = self._endpoint\n    headers = {\n        'Authorization': f'Bearer {self._apikey}',\n        'Content-Type' : 'application/json; charset=utf-8' }\n\n    self.gen_chat_content(text)\n    data = {\n      'model': self.model,\n      'input': self.chat_history,\n      #'tools': [{\"type\": \"mcp\", \"server_label\": \"web-search\" }]\n      #'tools': [{\"type\": \"web_search_preview\"}],\n      'tools': [{\"type\": \"web_search\"}],\n    }\n    if self.prompt:\n      data[\"input\"].insert(0,\n          {\n            'role': \"developer\",\n            'content': self.prompt\n          })\n    try:\n      result = requests2.post(url, data=json.dumps(data).encode('utf-8'), headers=headers)\n      response = result.json()\n      return response\n    except:\n      print ('Error', data, json.dumps(data).encode())\n      return \"\"\n\n    def request(self, txt):\n        \"\"\"\n        label:\n            en: ' %1 request, txt: %2'\n        params:\n            txt:\n                name: txt\n        \"\"\"\n    result = self.talk(txt)\n    if result:\n      return self.get_system_chat_content(result)\n    return \"\"\n\n\n","version":"alpha2"}