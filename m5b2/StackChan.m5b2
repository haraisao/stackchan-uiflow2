{"category":"StackChan","color":"#249542","uiflow2":{"jscode":"const CUSTOM_STACKCHAN_LANGUAGES = {\n  \"CUSTOM_STACKCHAN_INIT\": {\n    \"en\": \"%1 init\"\n  },\n  \"CUSTOM_STACKCHAN_INIT_WEB\": {\n    \"en\": \" %1 init_web, n: %2, start: %3\"\n  },\n  \"CUSTOM_STACKCHAN_SETUP_CAMERA\": {\n    \"en\": \" %1 setup_camera\"\n  },\n  \"CUSTOM_STACKCHAN_DETECT_FACE\": {\n    \"en\": \" %1 detect_face, data: %2\"\n  },\n  \"CUSTOM_STACKCHAN_TRACKING_FACE\": {\n    \"en\": \" %1 tracking_face\"\n  },\n  \"CUSTOM_STACKCHAN_CLEAR_MSG\": {\n    \"en\": \" %1 clear_msg\"\n  },\n  \"CUSTOM_STACKCHAN_CONNECT_WLAN\": {\n    \"en\": \" %1 connect_wlan, trial: %2\"\n  },\n  \"CUSTOM_STACKCHAN_ISCONNECTED_WLAN\": {\n    \"en\": \" %1 isconnected_wlan\"\n  },\n  \"CUSTOM_STACKCHAN_SET_TORQUE\": {\n    \"en\": \" %1 set_torque, val: %2\"\n  },\n  \"CUSTOM_STACKCHAN_SET_GOAL_POSITION\": {\n    \"en\": \" %1 set_goal_position, pose: %2\"\n  },\n  \"CUSTOM_STACKCHAN_MOVE\": {\n    \"en\": \" %1 move, p_deg: %2, t_deg: %3\"\n  },\n  \"CUSTOM_STACKCHAN_SHOW_ASR_RESULT\": {\n    \"en\": \" %1 show_asr_result, result: %2\"\n  },\n  \"CUSTOM_STACKCHAN_PRINT_INFO\": {\n    \"en\": \" %1 print_info, msg: %2, color: %3\"\n  },\n  \"CUSTOM_STACKCHAN_PRINT_MESSAGE\": {\n    \"en\": \" %1 print_message, msg: %2, color: %3\"\n  },\n  \"CUSTOM_STACKCHAN_CAPTURE_IMAGE\": {\n    \"en\": \" %1 capture_image, arg: %2\"\n  },\n  \"CUSTOM_STACKCHAN_SET_MESSAGE\": {\n    \"en\": \" %1 set_message, data: %2\"\n  },\n  \"CUSTOM_STACKCHAN_SHOW_BATTERY_LEVEL\": {\n    \"en\": \" %1 show_battery_level\"\n  },\n  \"CUSTOM_STACKCHAN_START_DIALOG\": {\n    \"en\": \" %1 start_dialog\"\n  },\n  \"CUSTOM_STACKCHAN_TOGGLE_RAND_MOTION\": {\n    \"en\": \" %1 toggle_rand_motion\"\n  },\n  \"CUSTOM_STACKCHAN_TOGGLE_TRACKING\": {\n    \"en\": \" %1 toggle_tracking\"\n  },\n  \"CUSTOM_STACKCHAN_SET_FACE_ID\": {\n    \"en\": \" %1 set_face_id, id: %2\"\n  },\n  \"CUSTOM_STACKCHAN_SET_FACE_COLOR\": {\n    \"en\": \"%1 set_face_color,  color %2 bg_color %3\"\n  },\n  \"CUSTOM_STACKCHAN_GET_FACE_ID\": {\n    \"en\": \"get_face_id %1\"\n  },\n  \"CUSTOM_STACKCHAN_GET_CURRENT_POSE\": {\n    \"en\": \"get_current_pose %1\"\n  },\n  \"CUSTOM_STACKCHAN_UPDATE\": {\n    \"en\": \" %1 update\"\n  }\n};\n\nconst initType = 'custom_stackchan_init';\nBlockly.BlockRegExpList['custom_stackchan'] = {\n  regexp: new RegExp(/^custom_stackchan_/),\n  code: \"from StackChan import StackChan\",\n  initBlockType: initType,\n  categoryId: 'custom_stackchan',\n}\nBlockly.utils.registerLanguages(CUSTOM_STACKCHAN_LANGUAGES)\n\nBlockly.Msg.CUSTOM_STACKCHAN_HUE = '#249542'\nBlockly.Msg.CUSTOM_STACKCHAN = 'StackChan'\n\nBlockly.utils.getcustom_stackchanOptions = function() {\n  let options = [];\n  let list = Blockly.utils.getCustomNameList(initType);\n  for (let i = 0; i < list.length; i++) {\n    let value = list[i];\n    options.push([String(value), String(value)]);\n  }\n  if (options.length === 0) return [\n    ['stackchan_0', 'stackchan_0']\n  ];\n  return options;\n}\n\n\nBlockly.Blocks[\"custom_stackchan_init\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_INIT,\n      'args0': [\n        // { 'type': 'field_dropdown', 'name': 'NAME', 'options': Blockly.utils.getcustom_stackchanOptions },\n        {\n          'type': 'field_input',\n          'name': 'NAME',\n          'text': 'stackchan_0'\n        },\n\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n      \"tool\": []\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_init\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return `${varname} = StackChan()\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_init_web\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_INIT_WEB,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'n'\n        }, {\n          \"type\": \"field_switch\",\n          \"name\": \"start\",\n          \"options\": [\n            ['True', 'True'],\n            ['False', 'False']\n          ],\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_init_web\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var n = Blockly.Python.valueToCode(block, 'n', Blockly.Python.ORDER_FUNCTION_CALL);\n  var start = block.getFieldValue('start');\n  return `${varname}.init_web(${n}, ${start})\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_setup_camera\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_SETUP_CAMERA,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_setup_camera\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return `${varname}.setup_camera()\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_detect_face\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_DETECT_FACE,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'data'\n        },\n      ],\n      'output': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_detect_face\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var data = Blockly.Python.valueToCode(block, 'data', Blockly.Python.ORDER_FUNCTION_CALL);\n  return [`${varname}.detect_face(${data})`, Blockly.Python.ORDER_NONE]\n}\n\nBlockly.Blocks[\"custom_stackchan_tracking_face\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_TRACKING_FACE,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_tracking_face\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return `${varname}.tracking_face()\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_clear_msg\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_CLEAR_MSG,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_clear_msg\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return `${varname}.clear_msg()\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_connect_wlan\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_CONNECT_WLAN,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'trial'\n        },\n      ],\n      'output': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_connect_wlan\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var trial = Blockly.Python.valueToCode(block, 'trial', Blockly.Python.ORDER_FUNCTION_CALL);\n  return [`${varname}.connect_wlan(${trial})`, Blockly.Python.ORDER_NONE]\n}\n\nBlockly.Blocks[\"custom_stackchan_isconnected_wlan\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_ISCONNECTED_WLAN,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n\n      ],\n      'output': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_isconnected_wlan\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return [`${varname}.isconnected_wlan()`, Blockly.Python.ORDER_NONE]\n}\n\nBlockly.Blocks[\"custom_stackchan_set_torque\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_SET_TORQUE,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'val'\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_set_torque\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var val = Blockly.Python.valueToCode(block, 'val', Blockly.Python.ORDER_FUNCTION_CALL);\n  return `${varname}.set_torque(${val})\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_set_goal_position\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_SET_GOAL_POSITION,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'pose'\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_set_goal_position\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var pose = Blockly.Python.valueToCode(block, 'pose', Blockly.Python.ORDER_FUNCTION_CALL);\n  return `${varname}.set_goal_position(${pose})\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_move\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_MOVE,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'p_deg'\n        }, {\n          'type': 'input_value',\n          'name': 't_deg'\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_move\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var p_deg = Blockly.Python.valueToCode(block, 'p_deg', Blockly.Python.ORDER_FUNCTION_CALL);\n  var t_deg = Blockly.Python.valueToCode(block, 't_deg', Blockly.Python.ORDER_FUNCTION_CALL);\n  return `${varname}.move(${p_deg}, ${t_deg})\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_show_asr_result\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_SHOW_ASR_RESULT,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'result'\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_show_asr_result\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var result = Blockly.Python.valueToCode(block, 'result', Blockly.Python.ORDER_FUNCTION_CALL);\n  return `${varname}.show_asr_result(${result})\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_print_info\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_PRINT_INFO,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'msg'\n        }, {\n          'type': 'input_value',\n          'name': 'color'\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_print_info\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var msg = Blockly.Python.valueToCode(block, 'msg', Blockly.Python.ORDER_FUNCTION_CALL);\n  var color = Blockly.Python.valueToCode(block, 'color', Blockly.Python.ORDER_FUNCTION_CALL);\n  return `${varname}.print_info(${msg}, ${color})\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_print_message\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_PRINT_MESSAGE,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'msg'\n        }, {\n          'type': 'input_value',\n          'name': 'color'\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_print_message\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var msg = Blockly.Python.valueToCode(block, 'msg', Blockly.Python.ORDER_FUNCTION_CALL);\n  var color = Blockly.Python.valueToCode(block, 'color', Blockly.Python.ORDER_FUNCTION_CALL);\n  return `${varname}.print_message(${msg}, ${color})\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_capture_image\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_CAPTURE_IMAGE,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'arg'\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_capture_image\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var arg = Blockly.Python.valueToCode(block, 'arg', Blockly.Python.ORDER_FUNCTION_CALL);\n  return `${varname}.capture_image(${arg})\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_set_message\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_SET_MESSAGE,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'data'\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_set_message\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var data = Blockly.Python.valueToCode(block, 'data', Blockly.Python.ORDER_FUNCTION_CALL);\n  return `${varname}.set_message(${data})\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_show_battery_level\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_SHOW_BATTERY_LEVEL,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_show_battery_level\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return `${varname}.show_battery_level()\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_start_dialog\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_START_DIALOG,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_start_dialog\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return `${varname}.start_dialog()\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_toggle_rand_motion\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_TOGGLE_RAND_MOTION,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_toggle_rand_motion\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return `${varname}.toggle_rand_motion()\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_toggle_tracking\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_TOGGLE_TRACKING,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_toggle_tracking\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return `${varname}.toggle_tracking()\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_set_face_id\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_SET_FACE_ID,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'id'\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_set_face_id\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var id = Blockly.Python.valueToCode(block, 'id', Blockly.Python.ORDER_FUNCTION_CALL);\n  return `${varname}.set_face_id(${id})\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_set_face_color\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_SET_FACE_COLOR,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'color'\n        }, {\n          'type': 'input_value',\n          'name': 'bg_color'\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_set_face_color\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var color = Blockly.Python.valueToCode(block, 'color', Blockly.Python.ORDER_FUNCTION_CALL);\n  var bg_color = Blockly.Python.valueToCode(block, 'bg_color', Blockly.Python.ORDER_FUNCTION_CALL);\n  return `${varname}.set_face_color(${color}, ${bg_color})\\n`\n}\n\nBlockly.Blocks[\"custom_stackchan_get_face_id\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_GET_FACE_ID,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n\n      ],\n      'output': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_get_face_id\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return [`${varname}.get_face_id()`, Blockly.Python.ORDER_NONE]\n}\n\nBlockly.Blocks[\"custom_stackchan_get_current_pose\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_GET_CURRENT_POSE,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n\n      ],\n      'output': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_get_current_pose\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return [`${varname}.get_current_pose()`, Blockly.Python.ORDER_NONE]\n}\n\nBlockly.Blocks[\"custom_stackchan_update\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_STACKCHAN_UPDATE,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_stackchanOptions\n        },\n\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#249542\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_stackchan_update\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return `${varname}.update()\\n`\n}","toolbox":"\n<category name=\"StackChan\" colour=\"#249542\" hidden=\"true\" toolboxitemid=\"custom_stackchan\">\n<title text=\"StackChan\" docsLink=\"\"></title>\n<block type=\"custom_stackchan_init\"/><block type=\"custom_stackchan_init_web\">\n  <value name=\"n\">\n    <shadow type=\"math_number\">\n      <field name=\"NUM\">80</field>\n    </shadow>\n  </value>\n  <field name=\"start\">False</field>\n</block><block type=\"custom_stackchan_setup_camera\"/><block type=\"custom_stackchan_detect_face\">\n  <value name=\"data\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block><block type=\"custom_stackchan_tracking_face\"/><block type=\"custom_stackchan_clear_msg\"/><block type=\"custom_stackchan_connect_wlan\">\n  <value name=\"trial\">\n    <shadow type=\"math_number\">\n      <field name=\"NUM\">10</field>\n    </shadow>\n  </value>\n</block><block type=\"custom_stackchan_isconnected_wlan\"/><block type=\"custom_stackchan_set_torque\">\n  <value name=\"val\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block><block type=\"custom_stackchan_set_goal_position\">\n  <value name=\"pose\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block><block type=\"custom_stackchan_move\">\n  <value name=\"p_deg\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n  <value name=\"t_deg\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block><block type=\"custom_stackchan_show_asr_result\">\n  <value name=\"result\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block><block type=\"custom_stackchan_print_info\">\n  <value name=\"msg\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n  <value name=\"color\">\n    <shadow type=\"math_number\">\n      <field name=\"NUM\">16776960</field>\n    </shadow>\n  </value>\n</block><block type=\"custom_stackchan_print_message\">\n  <value name=\"msg\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n  <value name=\"color\">\n    <shadow type=\"math_number\">\n      <field name=\"NUM\">16777215</field>\n    </shadow>\n  </value>\n</block><block type=\"custom_stackchan_capture_image\">\n  <value name=\"arg\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block><block type=\"custom_stackchan_set_message\">\n  <value name=\"data\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block><block type=\"custom_stackchan_show_battery_level\"/><block type=\"custom_stackchan_start_dialog\"/><block type=\"custom_stackchan_toggle_rand_motion\"/><block type=\"custom_stackchan_toggle_tracking\"/><block type=\"custom_stackchan_set_face_id\">\n  <value name=\"id\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block><block type=\"custom_stackchan_set_face_color\">\n  <value name=\"color\">\n    <shadow type=\"math_number\">\n      <field name=\"NUM\">16777215</field>\n    </shadow>\n  </value>\n  <value name=\"bg_color\">\n    <shadow type=\"math_number\">\n      <field name=\"NUM\">0</field>\n    </shadow>\n  </value>\n</block><block type=\"custom_stackchan_get_face_id\"/><block type=\"custom_stackchan_get_current_pose\"/><block type=\"custom_stackchan_update\"/>\n</category>\n","toolboxitemid":"custom_stackchan","block_type":["custom_stackchan___init__","custom_stackchan_init_web","custom_stackchan_setup_camera","custom_stackchan_detect_face","custom_stackchan_tracking_face","custom_stackchan_clear_msg","custom_stackchan_connect_wlan","custom_stackchan_isconnected_wlan","custom_stackchan_set_torque","custom_stackchan_set_goal_position","custom_stackchan_move","custom_stackchan_show_asr_result","custom_stackchan_print_info","custom_stackchan_print_message","custom_stackchan_capture_image","custom_stackchan_set_message","custom_stackchan_show_battery_level","custom_stackchan_start_dialog","custom_stackchan_toggle_rand_motion","custom_stackchan_toggle_tracking","custom_stackchan_set_face_id","custom_stackchan_set_face_color","custom_stackchan_get_face_id","custom_stackchan_get_current_pose","custom_stackchan_update"]},"data":{"name":"StackChan","note":{},"details":{"color":"#249542","link":"","image":"","category":"Custom"},"header":{"file":"","time":"","author":"","email":"","license":""},"assignments":[],"example":"","source_internal":"","source_external":"import M5\r\nimport json\r\nimport time\r\nimport binascii\r\nimport camera\r\nimport dl\r\nimport gc\r\nimport Face\r\nimport util\r\nimport WebServer\r","members":[{"name":"__init__","note":{},"label":{"en":"%1 init"},"params":[],"return":"","source":"    #util.mount_sd()\r\n    gc.enable()\r\n    try:\r\n      self.config=util.load_json(\"/flash/stackchan.json\")\r\n    except:\r\n      self.config={}\r\n\r\n    self.apikeys = util.load_conf(\"/flash/apikey.txt\")\r\n    self.wlan_conf = util.load_json(\"/flash/wlan.json\")\r\n\r\n    print(self.config)\r\n    # WLAN\r\n    self.wlan = util.connect_wlan()\r\n    self.camera_setupted = False\r\n    self.tracking_flag = False\r\n\r\n    if self.config.get('camera_setup'):\r\n      self.setup_camera()\r\n\r\n    #\r\n    # face, motors, TTS client, ASR client\r\n    self.face=Face.Face()\r\n    self.web_server=None\r\n    self.motor=None\r\n    self.set_motor()\r\n    self.tts=None\r\n    self.set_tts()\r\n    self.asr=None\r\n    self.set_asr()\r\n    self.dialog=None\r\n    self.setup_dialog()\r\n\r\n    self.event_time=time.time()\r\n    self.debug_time=time.time()\r\n    self.debug = 0\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"init_web","note":{},"label":{"en":" %1 init_web, n: %2, start: %3"},"params":[{"name":"n","type":"int","default":"80","note":{},"field":""},{"name":"start","type":"bool","default":"False","note":{},"field":"switch"}],"return":"","source":"    if self.config.get('web_server'):\r\n      port = int(self.config['web_server'])\r\n    else:\r\n      port = n\r\n  \r\n    self.web_server=WebServer.WebServer(port)\r\n    #\r\n    # Register REST API\r\n    self.web_server.registerCommand(\"/move\", self.set_goal_position)\r\n    self.web_server.registerCommand(\"/face\", self.face.set_face_id)\r\n    self.web_server.registerCommand(\"/get_camera_image\", self.capture_image)\r\n    self.web_server.registerCommand(\"/set_message\", self.set_message)\r\n    self.web_server.registerCommand(\"/command\", self.request_command)\r\n    if self.tts:\r\n        self.web_server.registerCommand(\"/tts\", self.tts.set_request)\r\n    if self.asr:\r\n        self.web_server.registerCommand(\"/asr\", self.asr.set_request)\r\n\r\n    #if start:\r\n    #  self.start_web_server()\r\n    return\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"setup_camera","note":{},"label":{"en":" %1 setup_camera"},"params":[],"return":"","source":"    camera.init(pixformat=camera.RGB565, framesize=camera.QVGA)\r\n    if 'vflip' in self.config:\r\n      camera.set_vflip(self.config['vflip'])\r\n\r\n    self.face_detector = dl.ObjectDetector(dl.model.HUMAN_FACE_DETECT)\r\n    self.camera_setupted = True \r\n    return\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"detect_face","note":{},"label":{"en":" %1 detect_face, data: %2"},"params":[{"name":"data","type":"str","default":"","note":{},"field":""}],"return":"","source":"    if not self.camera_setupted : return None \r\n    img = camera.snapshot()\r\n    detection_result = self.face_detector.infer(img)\r\n    face_pos=[]\r\n    if detection_result:\r\n      for res in detection_result:\r\n        #kp = res.keypoint()\r\n        face_pos.append([res.x(), res.y(), res.w(), res.h()])\r\n    return face_pos\r","ast_return":{"code":"face_pos","id":null},"doc_return":null},{"name":"tracking_face","note":{},"label":{"en":" %1 tracking_face"},"params":[],"return":"","source":"    if not self.tracking_flag:\r\n      time.sleep_ms(50)\r\n      return \r\n    face_pos_ = self.detect_face()\r\n    if face_pos_ :\r\n      pos_ =face_pos_[0]\r\n      center_x = pos_[0]+pos_[2]//2\r\n      center_y = pos_[1]+pos_[3]//2\r\n      print(\"Face:\", center_x, center_y, pos_[2], pos_[3])\r\n      if pos_[3] > 60:\r\n        dx = center_x - 160\r\n        dy = center_y - 120\r\n        cpos = self.motor.current_pos\r\n        if abs(dx) > 10 or  abs(dy) > 10: \r\n          dx_deg = cpos[0] + dx / 20.0\r\n          dy_deg = cpos[1] + dy / 20.0\r\n          #print(cpos, dx, dy, dx_deg, dy_deg)\r\n          self.motor.motor(True)\r\n          self.motor.move(dx_deg, dy_deg)\r\n      if pos_[3] > 160:\r\n        self.start_dialog()\r\n    return\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"clear_msg","note":{},"label":{"en":" %1 clear_msg"},"params":[],"return":"","source":"    self.face.print_info()\r\n    self.face.print_message()\r\n    return\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"connect_wlan","note":{},"label":{"en":" %1 connect_wlan, trial: %2"},"params":[{"name":"trial","type":"int","default":"10","note":{},"field":""}],"return":"","source":"    for _ in range(trial):\r\n      if self.wlan and self.wlan.isconnected():\r\n        self.face.print_info(\"IP:\" + self.wlan.ifconfig()[0])\r\n        return True\r\n      else:\r\n        self.face.print_info(\"Connecting...\")\r\n        self.wlan = util.connect_wlan(self.wlan)\r\n        time.sleep(1)\r\n    self.face.print_info(\"WLAN not connected\")\r\n    return False\r","ast_return":{"code":"False","id":null},"doc_return":null},{"name":"isconnected_wlan","note":{},"label":{"en":" %1 isconnected_wlan"},"params":[],"return":"","source":"    if self.wlan:\r\n      return self.wlan.isconnected()\r\n    return False\r","ast_return":{"code":"False","id":null},"doc_return":null},{"name":"set_torque","note":{},"label":{"en":" %1 set_torque, val: %2"},"params":[{"name":"val","type":null,"default":null,"note":{},"field":""}],"return":"","source":"    try:\r\n      if isinstance(val, str): val = eval(val)\r\n      self.motor.setTorque(val)\r\n    except:\r\n      pass\r\n    return True\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"set_goal_position","note":{},"label":{"en":" %1 set_goal_position, pose: %2"},"params":[{"name":"pose","type":null,"default":null,"note":{},"field":""}],"return":"","source":"    if self.motor:\r\n      if isinstance(pose, str):\r\n        pose = eval(pose)\r\n      self.motor.move(pose[0], pose[1])\r\n      return True\r\n    return False\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"move","note":{},"label":{"en":" %1 move, p_deg: %2, t_deg: %3"},"params":[{"name":"p_deg","type":null,"default":null,"note":{},"field":""},{"name":"t_deg","type":null,"default":null,"note":{},"field":""}],"return":"","source":"    self.motor.move(p_deg, t_deg, force=True)\r\n    return\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"show_asr_result","note":{},"label":{"en":" %1 show_asr_result, result: %2"},"params":[{"name":"result","type":null,"default":null,"note":{},"field":""}],"return":"","source":"    if result and result.get('error') == '':\r\n      self.print_info(result.get('result'))\r\n    return True\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"print_info","note":{},"label":{"en":" %1 print_info, msg: %2, color: %3"},"params":[{"name":"msg","type":"str","default":"","note":{},"field":""},{"name":"color","type":"int","default":"16776960","note":{},"field":""}],"return":"","source":"    self.face.print_info(msg,color)\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"print_message","note":{},"label":{"en":" %1 print_message, msg: %2, color: %3"},"params":[{"name":"msg","type":"str","default":"","note":{},"field":""},{"name":"color","type":"int","default":"16777215","note":{},"field":""}],"return":"","source":"    self.face.print_message(msg,color)\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"capture_image","note":{},"label":{"en":" %1 capture_image, arg: %2"},"params":[{"name":"arg","type":null,"default":null,"note":{},"field":""}],"return":"","source":"    try:\r\n      frame = camera.snapshot()\r\n      print(\"capture image\")\r\n      raw_bytes = frame.bytearray()\r\n      encoded = binascii.b2a_base64(raw_bytes, newline=False).decode()\r\n      response = {\r\n          'width': frame.width(),\r\n          'height': frame.height(),\r\n          'data': encoded\r\n      }\r\n    except:\r\n      print(\"Error: Camera\")\r\n      response = {\r\n          'width': 0,\r\n          'height': 0,\r\n          'data': ''\r\n      }\r\n    gc.collect()\r\n    gc.mem_free()\r\n    return response\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"set_message","note":{},"label":{"en":" %1 set_message, data: %2"},"params":[{"name":"data","type":null,"default":null,"note":{},"field":""}],"return":"","source":"    try:\r\n      msg = json.loads(data)\r\n      if msg['type'] == 'info':\r\n        self.face.info = msg['message']\r\n      elif msg['type'] == 'message':\r\n        self.face.message = msg['message']\r\n      else:\r\n        self.face.message=''\r\n        self.face.info=''\r\n    except:\r\n      pass\r\n    return True\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"show_battery_level","note":{},"label":{"en":" %1 show_battery_level"},"params":[],"return":"","source":"    self.face.print_message('Battery: %d %%' % M5.Power.getBatteryLevel())\r\n    self.face.random_face()\r\n    return\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"start_dialog","note":{},"label":{"en":" %1 start_dialog"},"params":[],"return":"","source":"    data = '{\"max_seconds\": 6, \"threshold\": 41, \"max_count\": 1}'\r\n    self.asr.set_request(data)\r\n    return\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"toggle_rand_motion","note":{},"label":{"en":" %1 toggle_rand_motion"},"params":[],"return":"","source":"    if self.motor:\r\n      self.motor.toggle_rand_motion()\r\n      if self.motor.rand_motion:\r\n        self.face.print_message(\"Motion On\")\r\n      else:\r\n        self.face.print_message(\"Motion Off\",0xff8888)\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"toggle_tracking","note":{},"label":{"en":" %1 toggle_tracking"},"params":[],"return":"","source":"    if self.motor:\r\n      if self.tracking_flag:\r\n        self.face.print_message(\"Tracking Off\", 0xff8888)\r\n        self.tracking_flag=False\r\n      else:\r\n        self.tracking_flag=True\r\n        self.face.print_message(\"Tracking On\",0x88ff88)\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"set_face_id","note":{},"label":{"en":" %1 set_face_id, id: %2"},"params":[{"name":"id","type":null,"default":null,"note":{},"field":""}],"return":"","source":"    self.face.set_face_id(id)\r\n    return\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"set_face_color","note":{},"label":{"en":"%1 set_face_color,  color %2 bg_color %3"},"params":[{"name":"color","type":"int","default":"0xffffff","field":"number","options":""},{"name":"bg_color","type":"int","default":"0","field":"number","comment":"","options":""}],"ast_return":{"code":null,"id":null},"doc_return":null,"source":"        pass","return_type":null},{"name":"get_face_id","note":{},"label":{"en":"get_face_id %1"},"params":[],"ast_return":{"code":null,"id":"None"},"doc_return":null,"source":"        pass","return_type":null},{"name":"get_current_pose","note":{},"label":{"en":"get_current_pose %1"},"params":[],"ast_return":{"code":null,"id":"None"},"doc_return":null,"source":"        pass","return_type":null},{"name":"update","note":{},"label":{"en":" %1 update"},"params":[],"return":"","source":"    debug = time.time() - self.debug_time\r\n    if self.debug != debug:\r\n      #print(debug)\r\n      self.debug = debug\r\n    if self.web_server:\r\n      self.web_server.update()\r\n    self.face.update()\r\n    if self.camera_setupted:\r\n      self.tracking_face()\r\n    #return\r\n    #\r\n    if self.motor:\r\n      if self.motor.update():\r\n        #print(\"Debug\", debug)\r\n        return\r\n    #\r\n    if self.asr:\r\n      res=self.asr.check_request()\r\n      if res and self.dialog and res['result'] != '':\r\n          self.face.print_info(\"考え中…\")\r\n          result=self.dialog.request(res['result'])\r\n          try:\r\n            print(result)\r\n            if result == \"ありがとう\":\r\n              self.dialog.reset_chat()\r\n            self.tts.set_request(result.replace('*', ''))\r\n          except:\r\n            print(result)\r\n      else:\r\n        if res is None:\r\n          pass\r\n          #self.tts.set_request(\"対話終了\")\r\n        elif res and res['result'] == '':\r\n          self.tts.set_request(\"何？\")\r\n        self.show_asr_result(res)\r\n    if self.tts:\r\n      self.tts.check_request()\r\n    return\r","ast_return":{"code":null,"id":null},"doc_return":null}],"python_file_name":"stackchan"},"pyCode":"\n\"\"\"\nfile     StackChan\ntime     2025-12-23\nauthor   \nemail   \nlicense  \n\"\"\"\n\nimport M5\nimport json\nimport time\nimport binascii\nimport camera\nimport dl\nimport gc\nimport Face\nimport util\nimport WebServer\n\nclass StackChan:\n    \"\"\"\n    note: ''\n    details:\n        color: '#249542'\n        link: ''\n        image: ''\n        category: Custom\n    example: ''\n    \"\"\"\n\n\n\n\n    def __init__(self):\n        \"\"\"\n        label:\n            en: '%1 init'\n        \"\"\"\n    #util.mount_sd()\n    gc.enable()\n    try:\n      self.config=util.load_json(\"/flash/stackchan.json\")\n    except:\n      self.config={}\n\n    self.apikeys = util.load_conf(\"/flash/apikey.txt\")\n    self.wlan_conf = util.load_json(\"/flash/wlan.json\")\n\n    print(self.config)\n    # WLAN\n    self.wlan = util.connect_wlan()\n    self.camera_setupted = False\n    self.tracking_flag = False\n\n    if self.config.get('camera_setup'):\n      self.setup_camera()\n\n    #\n    # face, motors, TTS client, ASR client\n    self.face=Face.Face()\n    self.web_server=None\n    self.motor=None\n    self.set_motor()\n    self.tts=None\n    self.set_tts()\n    self.asr=None\n    self.set_asr()\n    self.dialog=None\n    self.setup_dialog()\n\n    self.event_time=time.time()\n    self.debug_time=time.time()\n    self.debug = 0\n\n    def init_web(self, n: int = 80, start: bool = False):\n        \"\"\"\n        label:\n            en: ' %1 init_web, n: %2, start: %3'\n        params:\n            n:\n                name: n\n                type: int\n                default: '80'\n            start:\n                name: start\n                type: bool\n                default: 'False'\n                field: switch\n        \"\"\"\n    if self.config.get('web_server'):\n      port = int(self.config['web_server'])\n    else:\n      port = n\n  \n    self.web_server=WebServer.WebServer(port)\n    #\n    # Register REST API\n    self.web_server.registerCommand(\"/move\", self.set_goal_position)\n    self.web_server.registerCommand(\"/face\", self.face.set_face_id)\n    self.web_server.registerCommand(\"/get_camera_image\", self.capture_image)\n    self.web_server.registerCommand(\"/set_message\", self.set_message)\n    self.web_server.registerCommand(\"/command\", self.request_command)\n    if self.tts:\n        self.web_server.registerCommand(\"/tts\", self.tts.set_request)\n    if self.asr:\n        self.web_server.registerCommand(\"/asr\", self.asr.set_request)\n\n    #if start:\n    #  self.start_web_server()\n    return\n\n    def setup_camera(self):\n        \"\"\"\n        label:\n            en: ' %1 setup_camera'\n        \"\"\"\n    camera.init(pixformat=camera.RGB565, framesize=camera.QVGA)\n    if 'vflip' in self.config:\n      camera.set_vflip(self.config['vflip'])\n\n    self.face_detector = dl.ObjectDetector(dl.model.HUMAN_FACE_DETECT)\n    self.camera_setupted = True \n    return\n\n    def detect_face(self, data: str):\n        \"\"\"\n        label:\n            en: ' %1 detect_face, data: %2'\n        params:\n            data:\n                name: data\n                type: str\n        \"\"\"\n    if not self.camera_setupted : return None \n    img = camera.snapshot()\n    detection_result = self.face_detector.infer(img)\n    face_pos=[]\n    if detection_result:\n      for res in detection_result:\n        #kp = res.keypoint()\n        face_pos.append([res.x(), res.y(), res.w(), res.h()])\n    return face_pos\n\n    def tracking_face(self):\n        \"\"\"\n        label:\n            en: ' %1 tracking_face'\n        \"\"\"\n    if not self.tracking_flag:\n      time.sleep_ms(50)\n      return \n    face_pos_ = self.detect_face()\n    if face_pos_ :\n      pos_ =face_pos_[0]\n      center_x = pos_[0]+pos_[2]//2\n      center_y = pos_[1]+pos_[3]//2\n      print(\"Face:\", center_x, center_y, pos_[2], pos_[3])\n      if pos_[3] > 60:\n        dx = center_x - 160\n        dy = center_y - 120\n        cpos = self.motor.current_pos\n        if abs(dx) > 10 or  abs(dy) > 10: \n          dx_deg = cpos[0] + dx / 20.0\n          dy_deg = cpos[1] + dy / 20.0\n          #print(cpos, dx, dy, dx_deg, dy_deg)\n          self.motor.motor(True)\n          self.motor.move(dx_deg, dy_deg)\n      if pos_[3] > 160:\n        self.start_dialog()\n    return\n\n    def clear_msg(self):\n        \"\"\"\n        label:\n            en: ' %1 clear_msg'\n        \"\"\"\n    self.face.print_info()\n    self.face.print_message()\n    return\n\n    def connect_wlan(self, trial: int = 10):\n        \"\"\"\n        label:\n            en: ' %1 connect_wlan, trial: %2'\n        params:\n            trial:\n                name: trial\n                type: int\n                default: '10'\n        \"\"\"\n    for _ in range(trial):\n      if self.wlan and self.wlan.isconnected():\n        self.face.print_info(\"IP:\" + self.wlan.ifconfig()[0])\n        return True\n      else:\n        self.face.print_info(\"Connecting...\")\n        self.wlan = util.connect_wlan(self.wlan)\n        time.sleep(1)\n    self.face.print_info(\"WLAN not connected\")\n    return False\n\n    def isconnected_wlan(self):\n        \"\"\"\n        label:\n            en: ' %1 isconnected_wlan'\n        \"\"\"\n    if self.wlan:\n      return self.wlan.isconnected()\n    return False\n\n    def set_torque(self, val):\n        \"\"\"\n        label:\n            en: ' %1 set_torque, val: %2'\n        params:\n            val:\n                name: val\n        \"\"\"\n    try:\n      if isinstance(val, str): val = eval(val)\n      self.motor.setTorque(val)\n    except:\n      pass\n    return True\n\n    def set_goal_position(self, pose):\n        \"\"\"\n        label:\n            en: ' %1 set_goal_position, pose: %2'\n        params:\n            pose:\n                name: pose\n        \"\"\"\n    if self.motor:\n      if isinstance(pose, str):\n        pose = eval(pose)\n      self.motor.move(pose[0], pose[1])\n      return True\n    return False\n\n    def move(self, p_deg, t_deg):\n        \"\"\"\n        label:\n            en: ' %1 move, p_deg: %2, t_deg: %3'\n        params:\n            p_deg:\n                name: p_deg\n            t_deg:\n                name: t_deg\n        \"\"\"\n    self.motor.move(p_deg, t_deg, force=True)\n    return\n\n    def show_asr_result(self, result):\n        \"\"\"\n        label:\n            en: ' %1 show_asr_result, result: %2'\n        params:\n            result:\n                name: result\n        \"\"\"\n    if result and result.get('error') == '':\n      self.print_info(result.get('result'))\n    return True\n\n    def print_info(self, msg: str, color: int = 16776960):\n        \"\"\"\n        label:\n            en: ' %1 print_info, msg: %2, color: %3'\n        params:\n            msg:\n                name: msg\n                type: str\n            color:\n                name: color\n                type: int\n                default: '16776960'\n        \"\"\"\n    self.face.print_info(msg,color)\n\n    def print_message(self, msg: str, color: int = 16777215):\n        \"\"\"\n        label:\n            en: ' %1 print_message, msg: %2, color: %3'\n        params:\n            msg:\n                name: msg\n                type: str\n            color:\n                name: color\n                type: int\n                default: '16777215'\n        \"\"\"\n    self.face.print_message(msg,color)\n\n    def capture_image(self, arg):\n        \"\"\"\n        label:\n            en: ' %1 capture_image, arg: %2'\n        params:\n            arg:\n                name: arg\n        \"\"\"\n    try:\n      frame = camera.snapshot()\n      print(\"capture image\")\n      raw_bytes = frame.bytearray()\n      encoded = binascii.b2a_base64(raw_bytes, newline=False).decode()\n      response = {\n          'width': frame.width(),\n          'height': frame.height(),\n          'data': encoded\n      }\n    except:\n      print(\"Error: Camera\")\n      response = {\n          'width': 0,\n          'height': 0,\n          'data': ''\n      }\n    gc.collect()\n    gc.mem_free()\n    return response\n\n    def set_message(self, data):\n        \"\"\"\n        label:\n            en: ' %1 set_message, data: %2'\n        params:\n            data:\n                name: data\n        \"\"\"\n    try:\n      msg = json.loads(data)\n      if msg['type'] == 'info':\n        self.face.info = msg['message']\n      elif msg['type'] == 'message':\n        self.face.message = msg['message']\n      else:\n        self.face.message=''\n        self.face.info=''\n    except:\n      pass\n    return True\n\n    def show_battery_level(self):\n        \"\"\"\n        label:\n            en: ' %1 show_battery_level'\n        \"\"\"\n    self.face.print_message('Battery: %d %%' % M5.Power.getBatteryLevel())\n    self.face.random_face()\n    return\n\n    def start_dialog(self):\n        \"\"\"\n        label:\n            en: ' %1 start_dialog'\n        \"\"\"\n    data = '{\"max_seconds\": 6, \"threshold\": 41, \"max_count\": 1}'\n    self.asr.set_request(data)\n    return\n\n    def toggle_rand_motion(self):\n        \"\"\"\n        label:\n            en: ' %1 toggle_rand_motion'\n        \"\"\"\n    if self.motor:\n      self.motor.toggle_rand_motion()\n      if self.motor.rand_motion:\n        self.face.print_message(\"Motion On\")\n      else:\n        self.face.print_message(\"Motion Off\",0xff8888)\n\n    def toggle_tracking(self):\n        \"\"\"\n        label:\n            en: ' %1 toggle_tracking'\n        \"\"\"\n    if self.motor:\n      if self.tracking_flag:\n        self.face.print_message(\"Tracking Off\", 0xff8888)\n        self.tracking_flag=False\n      else:\n        self.tracking_flag=True\n        self.face.print_message(\"Tracking On\",0x88ff88)\n\n    def set_face_id(self, id):\n        \"\"\"\n        label:\n            en: ' %1 set_face_id, id: %2'\n        params:\n            id:\n                name: id\n        \"\"\"\n    self.face.set_face_id(id)\n    return\n\n    def set_face_color(self, color: int = 0xffffff, bg_color: int = 0):\n        \"\"\"\n        label:\n            en: '%1 set_face_color,  color %2 bg_color %3'\n        params:\n            color:\n                name: color\n                type: int\n                default: '0xffffff'\n                field: number\n            bg_color:\n                name: bg_color\n                type: int\n                default: '0'\n                field: number\n        \"\"\"\n        pass\n\n    def get_face_id(self) -> None:\n        \"\"\"\n        label:\n            en: get_face_id %1\n        \"\"\"\n        pass\n\n    def get_current_pose(self) -> None:\n        \"\"\"\n        label:\n            en: get_current_pose %1\n        \"\"\"\n        pass\n\n    def update(self):\n        \"\"\"\n        label:\n            en: ' %1 update'\n        \"\"\"\n    debug = time.time() - self.debug_time\n    if self.debug != debug:\n      #print(debug)\n      self.debug = debug\n    if self.web_server:\n      self.web_server.update()\n    self.face.update()\n    if self.camera_setupted:\n      self.tracking_face()\n    #return\n    #\n    if self.motor:\n      if self.motor.update():\n        #print(\"Debug\", debug)\n        return\n    #\n    if self.asr:\n      res=self.asr.check_request()\n      if res and self.dialog and res['result'] != '':\n          self.face.print_info(\"考え中…\")\n          result=self.dialog.request(res['result'])\n          try:\n            print(result)\n            if result == \"ありがとう\":\n              self.dialog.reset_chat()\n            self.tts.set_request(result.replace('*', ''))\n          except:\n            print(result)\n      else:\n        if res is None:\n          pass\n          #self.tts.set_request(\"対話終了\")\n        elif res and res['result'] == '':\n          self.tts.set_request(\"何？\")\n        self.show_asr_result(res)\n    if self.tts:\n      self.tts.check_request()\n    return\n\n\n","version":"alpha2"}