{"category":"Gemini","color":"#0f45d2","uiflow2":{"jscode":"const CUSTOM_GEMINI_LANGUAGES = {\n  \"CUSTOM_GEMINI_INIT\": {\n    \"en\": \"%1 init\"\n  },\n  \"CUSTOM_GEMINI_RESET_CHAT\": {\n    \"en\": \" %1 reset_chat\"\n  },\n  \"CUSTOM_GEMINI_SET_PROMPT\": {\n    \"en\": \" %1 set_prompt, prompt: %2\"\n  },\n  \"CUSTOM_GEMINI_REQUEST_GEMINI\": {\n    \"en\": \" %1 request_gemini, text: %2\"\n  },\n  \"CUSTOM_GEMINI_REQUEST\": {\n    \"en\": \" %1 request, txt: %2\"\n  }\n};\n\nconst initType = 'custom_gemini_init';\nBlockly.BlockRegExpList['custom_gemini'] = {\n  regexp: new RegExp(/^custom_gemini_/),\n  code: \"from Gemini import Gemini\",\n  initBlockType: initType,\n  categoryId: 'custom_gemini',\n}\nBlockly.utils.registerLanguages(CUSTOM_GEMINI_LANGUAGES)\n\nBlockly.Msg.CUSTOM_GEMINI_HUE = '#0f45d2'\nBlockly.Msg.CUSTOM_GEMINI = 'Gemini'\n\nBlockly.utils.getcustom_geminiOptions = function() {\n  let options = [];\n  let list = Blockly.utils.getCustomNameList(initType);\n  for (let i = 0; i < list.length; i++) {\n    let value = list[i];\n    options.push([String(value), String(value)]);\n  }\n  if (options.length === 0) return [\n    ['gemini_0', 'gemini_0']\n  ];\n  return options;\n}\n\n\nBlockly.Blocks[\"custom_gemini_init\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_GEMINI_INIT,\n      'args0': [\n        // { 'type': 'field_dropdown', 'name': 'NAME', 'options': Blockly.utils.getcustom_geminiOptions },\n        {\n          'type': 'field_input',\n          'name': 'NAME',\n          'text': 'gemini_0'\n        },\n\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#0f45d2\",\n      \"tool\": []\n    };\n  }\n}\n\nBlockly.Python[\"custom_gemini_init\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return `${varname} = Gemini()\\n`\n}\n\nBlockly.Blocks[\"custom_gemini_reset_chat\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_GEMINI_RESET_CHAT,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_geminiOptions\n        },\n\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#0f45d2\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_gemini_reset_chat\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n\n  return `${varname}.reset_chat()\\n`\n}\n\nBlockly.Blocks[\"custom_gemini_set_prompt\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_GEMINI_SET_PROMPT,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_geminiOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'prompt'\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#0f45d2\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_gemini_set_prompt\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var prompt = Blockly.Python.valueToCode(block, 'prompt', Blockly.Python.ORDER_FUNCTION_CALL);\n  return `${varname}.set_prompt(${prompt})\\n`\n}\n\nBlockly.Blocks[\"custom_gemini_request_gemini\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_GEMINI_REQUEST_GEMINI,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_geminiOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'text'\n        },\n      ],\n      'output': null,\n      'inputsInline': true,\n      'colour': \"#0f45d2\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_gemini_request_gemini\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var text = Blockly.Python.valueToCode(block, 'text', Blockly.Python.ORDER_FUNCTION_CALL);\n  return [`${varname}.request_gemini(${text})`, Blockly.Python.ORDER_NONE]\n}\n\nBlockly.Blocks[\"custom_gemini_request\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_GEMINI_REQUEST,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_geminiOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'txt'\n        },\n      ],\n      'output': null,\n      'inputsInline': true,\n      'colour': \"#0f45d2\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_gemini_request\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var txt = Blockly.Python.valueToCode(block, 'txt', Blockly.Python.ORDER_FUNCTION_CALL);\n  return [`${varname}.request(${txt})`, Blockly.Python.ORDER_NONE]\n}","toolbox":"\n<category name=\"Gemini\" colour=\"#0f45d2\" hidden=\"true\" toolboxitemid=\"custom_gemini\">\n<title text=\"Gemini\" docsLink=\"\"></title>\n<block type=\"custom_gemini_init\"/><block type=\"custom_gemini_reset_chat\"/><block type=\"custom_gemini_set_prompt\">\n  <value name=\"prompt\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block><block type=\"custom_gemini_request_gemini\">\n  <value name=\"text\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block><block type=\"custom_gemini_request\">\n  <value name=\"txt\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\"/>\n    </shadow>\n  </value>\n</block>\n</category>\n","toolboxitemid":"custom_gemini","block_type":["custom_gemini___init__","custom_gemini_reset_chat","custom_gemini_set_prompt","custom_gemini_request_gemini","custom_gemini_request"]},"data":{"name":"Gemini","note":{},"details":{"color":"#0f45d2","link":"","image":"","category":"Custom"},"header":{"file":"","time":"","author":"","email":"","license":""},"assignments":[],"example":"","source_internal":"","source_external":"import os\nfrom M5 import *\nimport requests2\nimport json\nimport util\ndef main():\n  from Gtts import GoogleTextToSpeech\n  from Gasr import GoogleSpeechRecog\n  gtts_client= GoogleTextToSpeech()\n  recog = GoogleSpeechRecog()\n\n\n  gemini = Gemini()\n  gemini.reset_chat()\n  reset_flag=False\n  while True:\n    print(\"＝＝＝＝ 話しかけてください\")\n    sample_text=recog.speech_recognition()\n    if sample_text is None: continue\n    if sample_text == 'さようなら': break\n    if sample_text == 'ありがとう':\n      reset_flag=True\n\n    result=gemini.request(sample_text)\n    if result:\n      print(\"RESPONSE:\", result)\n      gtts_client.speak(result.replace('*', ''))\n\n    if reset_flag:\n      gemini.reset_chat()\n      reset_flag=False\nif __name__ == '__main__':\n  main()","members":[{"name":"__init__","note":{},"label":{"en":"%1 init"},"params":[],"return":"","source":"    self._endpoint = \"https://generativelanguage.googleapis.com/v1beta/models\"\n    self.conf = util.load_conf(\"/flash/apikey.txt\")\n    self._apikey = self.conf.get('GEMINI_KEY')\n\n    self.model = \"/gemini-2.5-flash:generateContent\"\n    self._lang = 'ja-JP'\n    self.chat_history=[]\n    self.prompt = \"\"","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"reset_chat","note":{},"label":{"en":" %1 reset_chat"},"params":[],"return":"","source":"    self.chat_history=[]\n    return","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"set_prompt","note":{},"label":{"en":" %1 set_prompt, prompt: %2"},"params":[{"name":"prompt","type":null,"default":null,"note":{},"field":""}],"return":"","source":"    self.prompt=prompt\n    return","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"request_gemini","note":{},"label":{"en":" %1 request_gemini, text: %2"},"params":[{"name":"text","type":null,"default":null,"note":{},"field":""}],"return":"","source":"    url = self._endpoint+self.model\n    headers = { 'x-goog-api-key': self._apikey,\n                'Content-Type' : 'application/json; charset=utf-8' }\n\n    self.gen_chat_content(text)\n\n    data = {\n      \"contents\": self.chat_history,\n    }\n    if self.prompt:\n      data[\"system_instruction\"] = {\n          \"parts\" : [{\n           \"text\": self.prompt\n         }],\n         \"role\" : \"model\"\n      }\n    #\n    #\n    data[\"tools\"] = [\n            { \"url_context\": {} },\n            { \"google_search\": {} }\n            ]\n    try:\n      result = requests2.post(url, data=json.dumps(data).encode('utf-8'), headers=headers)\n      response = result.json()\n      return response\n    except:\n      print(result.json())\n      print ('Error', data, json.dumps(data).encode())\n      return \"\"","ast_return":{"code":"response","id":null},"doc_return":null},{"name":"request","note":{},"label":{"en":" %1 request, txt: %2"},"params":[{"name":"txt","type":null,"default":null,"note":{},"field":""}],"return":"","source":"    result = self.talk(txt)\n    if result:\n      return self.get_system_chat_content(result)\n    return \"\"","ast_return":{"code":"''","id":null},"doc_return":null}],"python_file_name":"gemini"},"pyCode":"\n\"\"\"\nfile     Gemini\ntime     2025-12-18\nauthor   \nemail   \nlicense  \n\"\"\"\n\nimport os\nfrom M5 import *\nimport requests2\nimport json\nimport util\ndef main():\n  from Gtts import GoogleTextToSpeech\n  from Gasr import GoogleSpeechRecog\n  gtts_client= GoogleTextToSpeech()\n  recog = GoogleSpeechRecog()\n\n\n  gemini = Gemini()\n  gemini.reset_chat()\n  reset_flag=False\n  while True:\n    print(\"＝＝＝＝ 話しかけてください\")\n    sample_text=recog.speech_recognition()\n    if sample_text is None: continue\n    if sample_text == 'さようなら': break\n    if sample_text == 'ありがとう':\n      reset_flag=True\n\n    result=gemini.request(sample_text)\n    if result:\n      print(\"RESPONSE:\", result)\n      gtts_client.speak(result.replace('*', ''))\n\n    if reset_flag:\n      gemini.reset_chat()\n      reset_flag=False\nif __name__ == '__main__':\n  main()\n\nclass Gemini:\n    \"\"\"\n    note: ''\n    details:\n        color: '#0f45d2'\n        link: ''\n        image: ''\n        category: Custom\n    example: ''\n    \"\"\"\n\n\n\n\n    def __init__(self):\n        \"\"\"\n        label:\n            en: '%1 init'\n        \"\"\"\n    self._endpoint = \"https://generativelanguage.googleapis.com/v1beta/models\"\n    self.conf = util.load_conf(\"/flash/apikey.txt\")\n    self._apikey = self.conf.get('GEMINI_KEY')\n\n    self.model = \"/gemini-2.5-flash:generateContent\"\n    self._lang = 'ja-JP'\n    self.chat_history=[]\n    self.prompt = \"\"\n\n    def reset_chat(self):\n        \"\"\"\n        label:\n            en: ' %1 reset_chat'\n        \"\"\"\n    self.chat_history=[]\n    return\n\n    def set_prompt(self, prompt):\n        \"\"\"\n        label:\n            en: ' %1 set_prompt, prompt: %2'\n        params:\n            prompt:\n                name: prompt\n        \"\"\"\n    self.prompt=prompt\n    return\n\n    def request_gemini(self, text):\n        \"\"\"\n        label:\n            en: ' %1 request_gemini, text: %2'\n        params:\n            text:\n                name: text\n        \"\"\"\n    url = self._endpoint+self.model\n    headers = { 'x-goog-api-key': self._apikey,\n                'Content-Type' : 'application/json; charset=utf-8' }\n\n    self.gen_chat_content(text)\n\n    data = {\n      \"contents\": self.chat_history,\n    }\n    if self.prompt:\n      data[\"system_instruction\"] = {\n          \"parts\" : [{\n           \"text\": self.prompt\n         }],\n         \"role\" : \"model\"\n      }\n    #\n    #\n    data[\"tools\"] = [\n            { \"url_context\": {} },\n            { \"google_search\": {} }\n            ]\n    try:\n      result = requests2.post(url, data=json.dumps(data).encode('utf-8'), headers=headers)\n      response = result.json()\n      return response\n    except:\n      print(result.json())\n      print ('Error', data, json.dumps(data).encode())\n      return \"\"\n\n    def request(self, txt):\n        \"\"\"\n        label:\n            en: ' %1 request, txt: %2'\n        params:\n            txt:\n                name: txt\n        \"\"\"\n    result = self.talk(txt)\n    if result:\n      return self.get_system_chat_content(result)\n    return \"\"\n\n\n","version":"alpha2"}