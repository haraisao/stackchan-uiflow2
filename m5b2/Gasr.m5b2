{"category":"Gasr","color":"#a3d20f","uiflow2":{"jscode":"const CUSTOM_GASR_LANGUAGES = {\n  \"CUSTOM_GASR_INIT\": {\n    \"en\": \"%1 init, node: %2 , language: %3\"\n  },\n  \"CUSTOM_GASR_DO_PROCESS\": {\n    \"en\": \" %1 do_process, max_seconds: %2, thr: %3, max_count: %4\"\n  }\n};\n\nconst initType = 'custom_gasr_init';\nBlockly.BlockRegExpList['custom_gasr'] = {\n  regexp: new RegExp(/^custom_gasr_/),\n  code: \"from Gasr import Gasr\",\n  initBlockType: initType,\n  categoryId: 'custom_gasr',\n}\nBlockly.utils.registerLanguages(CUSTOM_GASR_LANGUAGES)\n\nBlockly.Msg.CUSTOM_GASR_HUE = '#a3d20f'\nBlockly.Msg.CUSTOM_GASR = 'Gasr'\n\nBlockly.utils.getcustom_gasrOptions = function() {\n  let options = [];\n  let list = Blockly.utils.getCustomNameList(initType);\n  for (let i = 0; i < list.length; i++) {\n    let value = list[i];\n    options.push([String(value), String(value)]);\n  }\n  if (options.length === 0) return [\n    ['gasr_0', 'gasr_0']\n  ];\n  return options;\n}\n\n\nBlockly.Blocks[\"custom_gasr_init\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_GASR_INIT,\n      'args0': [\n        // { 'type': 'field_dropdown', 'name': 'NAME', 'options': Blockly.utils.getcustom_gasrOptions },\n        {\n          'type': 'field_input',\n          'name': 'NAME',\n          'text': 'gasr_0'\n        },\n        {\n          'type': 'input_value',\n          'name': 'node'\n        }, {\n          'type': 'input_value',\n          'name': 'language'\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#a3d20f\",\n      \"tool\": []\n    };\n  }\n}\n\nBlockly.Python[\"custom_gasr_init\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var node = Blockly.Python.valueToCode(block, 'node', Blockly.Python.ORDER_FUNCTION_CALL);\n  var language = Blockly.Python.valueToCode(block, 'language', Blockly.Python.ORDER_FUNCTION_CALL);\n  return `${varname} = Gasr(${node}, ${language})\\n`\n}\n\nBlockly.Blocks[\"custom_gasr_do_process\"] = {\n  init: function() {\n    this.jsonInit(this._init());\n  },\n  _init: function() {\n    return {\n      'message0': Blockly.Msg.CUSTOM_GASR_DO_PROCESS,\n      'args0': [{\n          'type': 'field_dropdown',\n          'name': 'NAME',\n          'options': Blockly.utils.getcustom_gasrOptions\n        },\n        {\n          'type': 'input_value',\n          'name': 'max_seconds'\n        }, {\n          'type': 'input_value',\n          'name': 'thr'\n        }, {\n          'type': 'input_value',\n          'name': 'max_count'\n        },\n      ],\n      'previousStatement': null,\n      'nextStatement': null,\n      'inputsInline': true,\n      'colour': \"#a3d20f\",\n    };\n  }\n}\n\nBlockly.Python[\"custom_gasr_do_process\"] = function(block) {\n  var varname = block.getFieldValue('NAME') || '_';\n  var max_seconds = Blockly.Python.valueToCode(block, 'max_seconds', Blockly.Python.ORDER_FUNCTION_CALL);\n  var thr = Blockly.Python.valueToCode(block, 'thr', Blockly.Python.ORDER_FUNCTION_CALL);\n  var max_count = Blockly.Python.valueToCode(block, 'max_count', Blockly.Python.ORDER_FUNCTION_CALL);\n  return `${varname}.do_process(${max_seconds}, ${thr}, ${max_count})\\n`\n}","toolbox":"\n<category name=\"Gasr\" colour=\"#a3d20f\" hidden=\"true\" toolboxitemid=\"custom_gasr\">\n<title text=\"Gasr\" docsLink=\"\"></title>\n<block type=\"custom_gasr_init\">\n  <value name=\"node\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\">None</field>\n    </shadow>\n  </value>\n  <value name=\"language\">\n    <shadow type=\"text\">\n      <field name=\"TEXT\">ja-JP</field>\n    </shadow>\n  </value>\n</block><block type=\"custom_gasr_do_process\">\n  <value name=\"max_seconds\">\n    <shadow type=\"math_number\">\n      <field name=\"NUM\">10</field>\n    </shadow>\n  </value>\n  <value name=\"thr\">\n    <shadow type=\"math_number\">\n      <field name=\"NUM\">41</field>\n    </shadow>\n  </value>\n  <value name=\"max_count\">\n    <shadow type=\"math_number\">\n      <field name=\"NUM\">0</field>\n    </shadow>\n  </value>\n</block>\n</category>\n","toolboxitemid":"custom_gasr","block_type":["custom_gasr___init__","custom_gasr_do_process"]},"data":{"name":"Gasr","note":{},"details":{"color":"#a3d20f","link":"","image":"","category":"Custom"},"header":{"file":"","time":"","author":"","email":"","license":""},"assignments":[],"example":"","source_internal":"","source_external":"import sys, os\r\nfrom M5 import Mic\r\nimport time\r\nimport json\r\nimport binascii\r\nimport requests2\r\nfrom comm import Command\r\nimport math\r\nimport struct\r\nimport util\r\ndef main():\r\n   recog = Gasr()\r\n   for n in range(5):\r\n     print(\"==== Start speech...\")\r\n     recog.do_process()\r\nif __name__ == '__main__':\r\n  main()\r","members":[{"name":"__init__","note":{},"label":{"en":"%1 init, node: %2 , language: %3"},"params":[{"name":"node","type":null,"default":"None","note":{},"field":""},{"name":"language","type":"str","default":"ja-JP","note":{},"field":""}],"return":"","source":"    self._endpoint = 'https://speech.googleapis.com/v1/speech:recognize'\r\n    self.key_config = util.load_conf(\"/flash/apikey.txt\")\r\n    self._apikey = self.key_config.get('GOOGLE_SPEECH_KEY')\r\n\r\n    self._lang=language\r\n\r\n    self._buffer = b''\r\n    self._audio = b''\r\n    self.audio_segments = []\r\n\r\n    self._sample_width=2\r\n    self._frame_rate=8000\r\n    self._channels=1\r\n\r\n    self._prebuf= b''\r\n    self.request=None\r\n    self.parent = None\r\n    self.response = None\r","ast_return":{"code":null,"id":null},"doc_return":null},{"name":"do_process","note":{},"label":{"en":" %1 do_process, max_seconds: %2, thr: %3, max_count: %4"},"params":[{"name":"max_seconds","type":"int","default":"10","note":{},"field":""},{"name":"thr","type":"int","default":"41","note":{},"field":""},{"name":"max_count","type":"int","default":"0","note":{},"field":""}],"return":"","source":"    if not self._apikey :\r\n      print(\"No API key\")\r\n      return\r\n    data=self.record_audio(max_seconds, thr, max_count)\r\n\r\n    if len(data) > 0:\r\n      self.show_message(\"音声認識中…\")\r\n      res_=self.request_speech_recog(data)\r\n      try:\r\n        response=json.loads(res_)\r\n        res=response['results'][0]['alternatives'][0]['transcript']\r\n        print(\"RESPONSE:\", res)\r\n        return { 'result': res , 'error': ''}\r\n      except:\r\n        print(\"==== Fail\")\r\n        #return None\r\n      return  { 'result': '', 'error': 'Fail to recoginze' }\r\n    else:\r\n      print(\"==== No sound\")\r\n      return None\r","ast_return":{"code":null,"id":null},"doc_return":null}],"python_file_name":"gasr"},"pyCode":"\n\"\"\"\nfile     Gasr\ntime     2025-12-18\nauthor   \nemail   \nlicense  \n\"\"\"\n\nimport sys, os\nfrom M5 import Mic\nimport time\nimport json\nimport binascii\nimport requests2\nfrom comm import Command\nimport math\nimport struct\nimport util\ndef main():\n   recog = Gasr()\n   for n in range(5):\n     print(\"==== Start speech...\")\n     recog.do_process()\nif __name__ == '__main__':\n  main()\n\nclass Gasr:\n    \"\"\"\n    note: ''\n    details:\n        color: '#a3d20f'\n        link: ''\n        image: ''\n        category: Custom\n    example: ''\n    \"\"\"\n\n\n\n\n    def __init__(self, node = None, language: str = 'ja-JP'):\n        \"\"\"\n        label:\n            en: '%1 init, node: %2 , language: %3'\n        params:\n            node:\n                name: node\n                default: None\n            language:\n                name: language\n                type: str\n                default: ja-JP\n        \"\"\"\n    self._endpoint = 'https://speech.googleapis.com/v1/speech:recognize'\n    self.key_config = util.load_conf(\"/flash/apikey.txt\")\n    self._apikey = self.key_config.get('GOOGLE_SPEECH_KEY')\n\n    self._lang=language\n\n    self._buffer = b''\n    self._audio = b''\n    self.audio_segments = []\n\n    self._sample_width=2\n    self._frame_rate=8000\n    self._channels=1\n\n    self._prebuf= b''\n    self.request=None\n    self.parent = None\n    self.response = None\n\n    def do_process(self, max_seconds: int = 10, thr: int = 41, max_count: int = 0):\n        \"\"\"\n        label:\n            en: ' %1 do_process, max_seconds: %2, thr: %3, max_count: %4'\n        params:\n            max_seconds:\n                name: max_seconds\n                type: int\n                default: '10'\n            thr:\n                name: thr\n                type: int\n                default: '41'\n            max_count:\n                name: max_count\n                type: int\n                default: '0'\n        \"\"\"\n    if not self._apikey :\n      print(\"No API key\")\n      return\n    data=self.record_audio(max_seconds, thr, max_count)\n\n    if len(data) > 0:\n      self.show_message(\"音声認識中…\")\n      res_=self.request_speech_recog(data)\n      try:\n        response=json.loads(res_)\n        res=response['results'][0]['alternatives'][0]['transcript']\n        print(\"RESPONSE:\", res)\n        return { 'result': res , 'error': ''}\n      except:\n        print(\"==== Fail\")\n        #return None\n      return  { 'result': '', 'error': 'Fail to recoginze' }\n    else:\n      print(\"==== No sound\")\n      return None\n\n\n","version":"alpha2"}