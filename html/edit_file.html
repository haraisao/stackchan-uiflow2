<html>
  <head> 
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta charset="utf-8">
            <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
        <script src="https://hara-jp.com/js/jquery-linedtextarea.js"></script>
        <link href="https://hara-jp.com/css/jquery-linedtextarea.css" type="text/css" rel="stylesheet" />

        <script type="text/javascript">
            var get_dirlist=false;

            async function load_file(){
                var name = document.getElementById("file_name").value;
                var url ="/get_file"
                const response = await fetch(url,{
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json;charset=utf-8",
                    },
                    body: JSON.stringify({'file_name': name})
                }).catch(error =>{
                    alert("ERROR");
                    console.error('エラーが発生しました', error);
                });;

                const data = await response.json();
                console.log(data);
                document.getElementById("editarea").value=data['data'];
            }

            async function save_file(){
                var name = document.getElementById("file_name").value;
                var txt = document.getElementById("editarea").value;
                var url ="/save_file"
                const response = await fetch(url,{
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json;charset=utf-8",
                    },
                    body: JSON.stringify({'file_name': name, 'data': txt})
                }
                );
                console.log(response);
                alert("Save fiel: "+name);
            }

            async function upload_file(){
	        var name=document.getElementById('file_name').value;
	        var txt=document.getElementById('file_data').value;
                var url ="/save_file";
                const response = await fetch(url,{
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json;charset=utf-8",
                    },
                    body: JSON.stringify({'file_name': name, 'data': txt})
                });
                console.log(response);
                alert("Upload file: "+name);
            }

            async function get_file_list(){
	        var name=document.getElementById('dir_name').value;
	        if(!name ){
		    name=".";
	        }
          
                var url ="/get_file_list";
                const response = await fetch(url,{
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json;charset=utf-8",
                    },
                    body: JSON.stringify({'dir_name': name})
                }).catch(error =>{
                    alert("ERROR");
                    console.error('エラーが発生しました', error);
                });
                var res = await response.json();
	        var flst = document.getElementById('filelist');
	        var dlst = document.getElementById('dirlist');
	        console.log(res);
	        set_options(flst,res['file_list']);
	        set_options(dlst, res['dir_list']);
                get_dirlist=false;
	    }

	    function removeChildren(x) {
	        if (x.hasChildNodes()) {
		    while (x.childNodes.length > 0) {
	                x.removeChild(x.firstChild)
	            }
                }
            }

	    function set_options(ele, lst){
	        removeChildren(ele);
	        for(let n in lst){
		    let op = document.createElement('option');
		    op.text = lst[n];
		    op.value = lst[n];
		    ele.appendChild(op);
	        }
	    }

	    function select_dir(){
                const dirname = document.getElementById('dir_name');
                const dir_list = document.getElementById('dirlist');
		if (dirname.value){
                   if(get_dirlist){
                       var val = dirname.value.split("/")
                       val.pop();
                       if(val.length == 0){
                           dirname.value=dir_list.value;
                       }else{
		           dirname.value=val.join("/") +"/"+dir_list.value;
                       }
                    }else{
		       dirname.value=dirname.value +"/"+dir_list.value;
                    }
		}else{
		   dirname.value=dir_list.value;
		}
                get_dirlist=true;
	    }

	    function select_file(){

                const dirname = document.getElementById('dir_name');
                const filename = document.getElementById('file_name');
                const file_list = document.getElementById('filelist');
                const editarea = document.getElementById('editarea');
		editarea.value="";
		if (dirname.value){
		  filename.value=dirname.value +"/"+file_list.value;
		}else{
		  filename.value=file_list.value;
		}
                if(get_dirlist){
                  return;
                }
		load_file();
	    }

            function load_file_event(e){
                if (e.key == "Enter"){
                    load_file();
                }
            }

            function init(){
                const fname_form = document.getElementById('file_name');
                fname_form.addEventListener("keydown", load_file_event);
            }
    </script>
    <title>File manaher</title>
  </head>
  <body onLoad="init()">
    <h1>File manager</h1>
    <hr>

    <table style="width:100%">
    <tr>
    <td style="width:20%">
    DIR:<input type=text"  id="dir_name" value="" style="width:100px"> <button onClick="get_file_list()">GET List</button><br>
    </td>
    <td>
    Filename:  <input type="text" id="file_name" />
    <!--
        <input type="button" onClick="load_file()" value="Load" style="font-size:12pt;width:100px;">
    -->
        <input type="button" onClick="save_file()" value="Save" style="font-size:12pt;width:100px;">
    </td>
    </tr>
    <tr>
      <td>
	Dirs:<br>
       <select id="dirlist" size="5" onchange="select_dir()"></select><br>
      </td>
      <td rowspan="2">
        <hr>
        <textarea id="editarea" name="info" class="lined" style="width:100%;height:500px;line-height:1.5em"></textarea>
        <script>
            $(function() {
                $(".lined").linedtextarea();
            });
        </script>
      </td>
    </tr>
    <tr>
      <td>
	Files:<br>
       <select id="filelist" size="10" onchange="select_file()"></select><br>
	  
      </td>
    </tr>
    </table>

    <hr>
    <div>
    <input id="file_load" type="file"> 
    Upload to <input type="text"  id="file_name" value="" >
    <button onClick="upload_file()">Upload</button>
    <input type="hidden" id="file_data" />
    </div>

    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
          if(window.File && window.FileReader){
            const elem_file_load = document.getElementById("file_load");
            elem_file_load.addEventListener("change", (event) => {
            const input_file = event.target.files[0];

            const f_reader = new FileReader();

            f_reader.onload = (event) => {
              const elem_file_name = document.getElementById("file_name");
              const elem_file_data = document.getElementById("file_data");

              elem_file_name.value = input_file.name;
              elem_file_data.value = event.target.result;
            };
            f_reader.readAsText(input_file);
          });
        } else {
          alert("File API is not available");
          return false;
        }
        });
    </script>

        <a href="/">Back to Top</a>
  </body>
</html>
